import os
import sys

from gentropy.common.session import Session
from gentropy.susie_finemapper import SusieFineMapperStep
import hail as hl

batch_task_index = int(sys.argv[1])
print(f"This is worker for task # {batch_task_index}")

# Temporary substituion for fixing missing runs...
batch_task_index = [10027,10062,10066,10076,10115,10139,10170,10205,1027,10322,10349,10362,1042,10432,10442,10484,10561,10597,10695,10715,10741,10746,10752,10775,10815,10898,10995,1107,11071,11074,11094,11102,11147,11156,11187,11190,11198,11266,11269,11304,11332,11337,1135,11354,11371,11435,11475,1148,11540,11544,11555,11573,11620,11659,11730,11794,11806,11841,11849,11868,11888,11889,11922,11925,11992,1203,12031,12043,12197,12215,12241,12243,12261,1228,1235,12379,124,12411,12428,1245,12457,1250,12511,12566,12570,12590,12606,12627,12655,12730,1279,12876,1298,13020,1305,13083,13174,13206,13218,13221,13228,13234,13259,13295,13307,13327,13381,13384,13390,1342,13427,13454,1346,13480,13482,13577,13626,13675,13676,13695,13706,1372,1373,13791,13841,13875,13880,13883,13890,14085,1409,14091,14102,14114,14122,14140,14176,14213,14217,14274,14359,1439,14404,1443,14435,14440,1447,14489,14558,14618,14635,14707,14709,14910,14924,14930,14946,14961,14977,15072,15081,15150,15251,15350,15364,15486,15559,15560,15574,15599,15704,15711,15723,15736,15737,15769,15831,15837,15840,15858,15920,15924,15997,1604,1650,1656,1657,1692,1715,1720,1724,1737,1744,1760,1761,1783,1784,1791,1822,1849,1869,1929,1944,1993,2007,2044,2052,2070,2086,2087,2088,2151,2163,2167,2175,2240,2273,2277,2350,2380,2459,246,2543,2559,2560,2721,2725,2734,2736,276,2795,2844,2984,3053,3062,3123,318,3185,3219,3289,337,3372,3407,3426,3445,3461,3485,3486,350,3508,3560,3566,3619,3645,3686,3695,3859,3875,3893,3925,3948,3970,3974,3995,4021,4057,4089,4105,4139,4150,4169,4176,4189,4193,424,429,4310,4325,4335,4343,4345,4348,4362,4375,4419,4463,4523,4524,4548,4618,4619,4669,4671,4705,4711,4815,4844,4849,4896,4912,4932,494,4957,4976,5,5054,5092,5175,5197,5230,5237,5245,5306,5311,5335,5382,5397,5418,5449,5490,5504,5557,559,5615,5761,5844,587,5937,5976,6014,6017,602,6037,6114,6126,6139,615,6212,6225,623,6258,6401,6412,6460,6467,653,6547,6586,6626,663,6698,6716,6829,6838,686,6884,6939,6971,7017,7018,709,7099,7256,7287,7408,7413,7432,7454,7474,7573,7592,7596,7609,7622,7650,7654,7656,7721,783,7830,7849,7899,791,793,7930,7983,7996,8007,8060,8110,8127,820,8225,8242,8248,825,8264,8282,8286,8308,8324,8357,84,8468,8477,8515,8524,8526,8536,8546,859,8673,8688,8710,8802,8817,8850,8879,8890,8957,9020,9052,9054,9075,9078,9079,9177,9221,924,9264,928,9292,9309,9315,9340,9348,951,9548,955,9619,9622,9660,967,9781,980,981,9868,987,9924,9944,9952][batch_task_index]

path_study_locus = "gs://ukb_ppp_eur_data/collected"
path_study_index = "gs://ukb_ppp_eur_data/study_index"
path_out = "gs://ukb_ppp_eur_data/finemapped"
logs_out = "gs://ukb_ppp_eur_data/finemapping_logs"

hail_home = os.path.dirname(hl.__file__)
session = Session(
    hail_home=hail_home,
    start_hail=True,
    extended_spark_conf={
        "spark.jars": "https://storage.googleapis.com/hadoop-lib/gcs/gcs-connector-hadoop3-latest.jar",
        "spark.dynamicAllocation.enabled": "false",
        "spark.driver.memory": "30g",
        "spark.kryoserializer.buffer.max": "500m",
        "spark.driver.maxResultSize": "5g",
    },
)

id_to_process = str(
    int(
        session.spark.read.parquet(path_study_locus)
        .select("studyLocusId")
        .toPandas()
        .loc[batch_task_index, "studyLocusId"]
    )
)

# Remove the path in case it already exists (re-run due to VM preemption, for example).
os.system(f"gsutil -m rm -r {path_out}/{id_to_process}")

SusieFineMapperStep(
    session=session,
    study_locus_to_finemap=id_to_process,
    study_locus_collected_path=path_study_locus,
    study_index_path=path_study_index,
    output_path=path_out,
    locus_radius=1_500_000,
    max_causal_snps=10,
    primary_signal_pval_threshold=1,
    secondary_signal_pval_threshold=1,
    purity_mean_r2_threshold=0,
    purity_min_r2_threshold=0,
    cs_lbf_thr=2,
    sum_pips=0.99,
    logging=True,
    susie_est_tausq=False,
    run_carma=False,
    run_sumstat_imputation=False,
    carma_time_limit=600,
    imputed_r2_threshold=0.9,
    ld_score_threshold=5,
    output_path_log=logs_out,
)